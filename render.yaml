version: 1
services:
  - type: web
    name: bike-rental-web-jkgi
    env: python
    plan: free
    branch: main

    buildCommand: >
      bash -lc '
      set -euo pipefail
      echo "Create venv..."
      python3 -m venv .venv
      # use pip from the venv directly to avoid system pip restrictions
      .venv/bin/python -m pip install --upgrade pip setuptools wheel
      echo "Installing requirements..."
      if [ -f requirements.txt ]; then
        .venv/bin/pip install -r requirements.txt
      else
        echo "ERROR: requirements.txt not found"; exit 1;
      fi
      echo "Running migrations and collectstatic..."
      .venv/bin/python manage.py migrate --noinput
      .venv/bin/python manage.py collectstatic --noinput
      echo "Build finished."
      '

    # Start using the venv gunicorn binary so runtime uses the same environment
    startCommand: >
      bash -lc '
      set -euo pipefail
      if [ -x .venv/bin/gunicorn ]; then
        exec .venv/bin/gunicorn config.wsgi:application --bind 0.0.0.0:$PORT
      else
        echo "ERROR: gunicorn not found in .venv; ensure gunicorn is in requirements.txt"; exit 1
      fi
      '

    healthCheckPath: /

    envVars:
      - key: SECRET_KEY
        value: ""
        scope: private
      - key: DEBUG
        value: "False"
        scope: private
      - key: STRIPE_SECRET_KEY
        value: ""
        scope: private
      - key: STRIPE_PUBLISHABLE_KEY
        value: ""
        scope: private
      - key: STRIPE_WEBHOOK_SECRET
        value: ""
        scope: private
      - key: DATABASE_URL
        value: ""
        scope: private
